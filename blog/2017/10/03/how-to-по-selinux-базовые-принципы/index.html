<!DOCTYPE html>
<html lang="ru-RU">
  <head>
    <title>How-to по SELinux, базовые принципы - The great nothingness</title>
    <meta charset="utf-8" />
    <meta name="author" content="Evgenii Lepikhin" />
    <meta name="description" content="Основы SELinux и работы с ним" />
    <meta name="keywords" content="SELinux, безопасность, linux, администрирование" />
    <link rel="stylesheet" href="/media/css/main.css" type="text/css">
    <link rel="stylesheet" href="/media/css/prettify.css" type="text/css">
  </head>
  <body class="container">
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="/">The great nothingness</a></h1>
        <p>.</p>
        <ul>
          <li><a href="/blog/">Blog</a></li>
          <li><a href="/mountaineering/">Mountaineering</a></li>
          <li><a href="/tech/">Tech</a></li>
          <li><a href="/tags/">Тэги</a></li>
          <li><a href="/about/">О блоге</a></li>
          <li><a href="/rss.xml">RSS</a></li>
        </ul>
        <form method="get" id="searchform" action="//www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Искать">
          <input type="hidden" name="as_sitesearch" value="johnlepikhin.github.io">
        </form>
        <img class="avatar" src="https://avatars0.githubusercontent.com/u/381986?v=4&amp;s=80" />
      </header>
    </div>

<div>
<div class="post">
<h1>How-to по SELinux, базовые принципы</h1>
<p>
По ра&shy;бо&shy;те раз&shy;би&shy;рал&shy;ся с SELinux под CentOS, на&shy;пи&shy;сал для се&shy;бя
до&shy;ку&shy;мен&shy;та&shy;цию. Решил по&shy;де&shy;лить&shy;ся.
</p>

<<<<<<< HEAD
<div id="outline-container-orgddbe502" class="outline-2">
<h2 id="orgddbe502">Подго&shy;то&shy;вка</h2>
<div class="outline-text-2" id="text-orgddbe502">
</div>
<div id="outline-container-orgb3c172e" class="outline-3">
<h3 id="orgb3c172e">Поста&shy;вить па&shy;ке&shy;ты (CentOS)</h3>
<div class="outline-text-3" id="text-orgb3c172e">
=======
<div id="outline-container-org94fa54f" class="outline-2">
<h2 id="org94fa54f">Подго&shy;то&shy;вка</h2>
<div class="outline-text-2" id="text-org94fa54f">
</div>
<div id="outline-container-org127d9a1" class="outline-3">
<h3 id="org127d9a1">Поста&shy;вить па&shy;ке&shy;ты (CentOS)</h3>
<div class="outline-text-3" id="text-org127d9a1">
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
<div class="org-src-container">
<pre class="src src-sh">yum install setools-console policycoreutils-python
</pre>
</div>
</div>
</div>
</div>

<<<<<<< HEAD
<div id="outline-container-org9b7a082" class="outline-2">
<h2 id="org9b7a082">Конц&shy;епт</h2>
<div class="outline-text-2" id="text-org9b7a082">
</div>
<div id="outline-container-orgf41dea0" class="outline-3">
<h3 id="orgf41dea0">Поли&shy;ти&shy;ки</h3>
<div class="outline-text-3" id="text-orgf41dea0">
<p>
Для вс&shy;ей си&shy;сте&shy;мы за&shy;да&shy;ет&shy;ся <a id="org52292ad"></a>policy, ко&shy;то&shy;рая бу&shy;дет при&shy;ме&shy;не&shy;на ко всем
=======
<div id="outline-container-orgc2e3475" class="outline-2">
<h2 id="orgc2e3475">Конц&shy;епт</h2>
<div class="outline-text-2" id="text-orgc2e3475">
</div>
<div id="outline-container-org35fd192" class="outline-3">
<h3 id="org35fd192">Поли&shy;ти&shy;ки</h3>
<div class="outline-text-3" id="text-org35fd192">
<p>
Для вс&shy;ей си&shy;сте&shy;мы за&shy;да&shy;ет&shy;ся <a id="org6853c6b"></a>policy, ко&shy;то&shy;рая бу&shy;дет при&shy;ме&shy;не&shy;на ко всем
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
об&shy;ъек&shy;там. По умо&shy;лча&shy;нию дейст&shy;ву&shy;ет по&shy;ли&shy;ти&shy;ка targeted. Поли&shy;ти&shy;ка за&shy;да&shy;ет&shy;ся
в фа&shy;йле <code>/etc/sysconfig/selinux</code>
</p>

<p>
Крат&shy;ко:
</p>
<ul class="org-ul">
<li><code>targeted</code>: всем всё раз&shy;ре&shy;ше&shy;но, за ис&shy;клю&shy;че&shy;ни&shy;ем про&shy;цес&shy;сов, для ко&shy;то&shy;рых
пра&shy;ви&shy;ла яв&shy;но за&shy;да&shy;ны (в CentOS их до&shy;воль&shy;но мно&shy;го, в ос&shy;нов&shy;ном се&shy;те&shy;вые
де&shy;мо&shy;ны)</li>
<li><code>strict</code>: то же что и targeted, толь&shy;ко до&shy;ступ ог&shy;ра&shy;ни&shy;чен и не толь&shy;ко
се&shy;те&shy;вым про&shy;цес&shy;сам</li>
<li><code>minimum</code> (в CentOS ста&shy;вит&shy;ся от&shy;дель&shy;но, па&shy;ке&shy;том
<code>selinux-policy-minimum</code>): targeted, толь&shy;ко по умо&shy;лча&shy;нию со&shy;всем нет
ни&shy;ка&shy;ких пра&shy;вил</li>
<li><code>MLS</code>: ?</li>
</ul>
</div>
</div>

<<<<<<< HEAD
<div id="outline-container-org7e52c99" class="outline-3">
<h3 id="org7e52c99">Режи&shy;мы SELinux</h3>
<div class="outline-text-3" id="text-org7e52c99">
<ul class="org-ul">
<li>disabled: SELinux вы&shy;клю&shy;чен</li>
<li><a id="org978354c"></a> <code>enforcing</code>: вклю&shy;чен, пра&shy;ви&shy;ла бло&shy;ки&shy;ру&shy;ют, со&shy;об&shy;ще&shy;ния о бло&shy;ки&shy;ров&shy;ке
ухо&shy;дят в <code>/var/log/audit/audit.log</code></li>
<li><a id="orga3c0079"></a> <code>permissive</code>: ни&shy;че&shy;го не бло&shy;ки&shy;ру&shy;ет&shy;ся, толь&shy;ко ухо&shy;дят со&shy;об&shy;ще&shy;ния в
=======
<div id="outline-container-orgd656613" class="outline-3">
<h3 id="orgd656613">Режи&shy;мы SELinux</h3>
<div class="outline-text-3" id="text-orgd656613">
<ul class="org-ul">
<li>disabled: SELinux вы&shy;клю&shy;чен</li>
<li><a id="orgea94b17"></a> <code>enforcing</code>: вклю&shy;чен, пра&shy;ви&shy;ла бло&shy;ки&shy;ру&shy;ют, со&shy;об&shy;ще&shy;ния о бло&shy;ки&shy;ров&shy;ке
ухо&shy;дят в <code>/var/log/audit/audit.log</code></li>
<li><a id="org4d9afc3"></a> <code>permissive</code>: ни&shy;че&shy;го не бло&shy;ки&shy;ру&shy;ет&shy;ся, толь&shy;ко ухо&shy;дят со&shy;об&shy;ще&shy;ния в
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
<code>/var/log/audit/audit.log</code></li>
</ul>

<p>
Пере&shy;клю&shy;чить&shy;ся в permissive:
</p>

<div class="org-src-container">
<pre class="src src-sh">setenforce 0
</pre>
</div>

<p>
Пере&shy;клю&shy;чить&shy;ся в enforcing:
</p>

<div class="org-src-container">
<pre class="src src-sh">setenforce 1
</pre>
</div>
</div>
</div>

<<<<<<< HEAD
<div id="outline-container-orgdb6b2a7" class="outline-3">
<h3 id="orgdb6b2a7">Кон&shy;тек&shy;сты</h3>
<div class="outline-text-3" id="text-orgdb6b2a7">
<p>
Каж&shy;дый об&shy;ъект ми&shy;ра (файл, про&shy;цесс и т.д.) име&shy;ют свойст&shy;во <a id="org77ed9e0"></a>context. В
=======
<div id="outline-container-orgd58659a" class="outline-3">
<h3 id="orgd58659a">Кон&shy;тек&shy;сты</h3>
<div class="outline-text-3" id="text-orgd58659a">
<p>
Каж&shy;дый об&shy;ъект ми&shy;ра (файл, про&shy;цесс и т.д.) име&shy;ют свойст&shy;во <a id="orga81d022"></a>context. В
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
SELinux со&shy;вер&shy;шен&shy;но не важ&shy;но кто и ку&shy;да сде&shy;лал su, fork и т.д.&nbsp;—
кон&shy;текст на&shy;следу&shy;ет&shy;ся до тех пор, по&shy;ка яв&shy;но в пра&shy;ви&shy;лах SELinux не
ска&shy;за&shy;но, что на&shy;до сме&shy;нить кон&shy;текст
</p>

<p>
Каж&shy;дый кон&shy;текст со&shy;сто&shy;ит из трех час&shy;тей:
</p>
<ol class="org-ol">
<<<<<<< HEAD
<li><a id="org3deae49"></a> <code>user</code></li>
<li><a id="orgf724b69"></a> <code>role</code></li>
<li><a id="orgb17243c"></a> <code>type</code> (у про&shy;цес&shy;сов его при&shy;ня&shy;то на&shy;зы&shy;вать <a id="orga73d3c9"></a>domain, но раз&shy;ни&shy;цы ни&shy;ка&shy;кой нет)</li>
=======
<li><a id="orgb880a68"></a> <code>user</code></li>
<li><a id="org732ef0f"></a> <code>role</code></li>
<li><a id="org06fbed7"></a> <code>type</code> (у про&shy;цес&shy;сов его при&shy;ня&shy;то на&shy;зы&shy;вать <a id="org02354ca"></a>domain, но раз&shy;ни&shy;цы ни&shy;ка&shy;кой нет)</li>
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
</ol>

<p>
Для фа&shy;йлов кон&shy;текст мож&shy;но по&shy;смот&shy;реть так:
</p>

<pre class="example">
# ls -dZ /
dr-xr-xr-x. root root system_u:object_r:root_t:s0      /
</pre>

<p>
Здесь:
</p>
<ul class="org-ul">
<li><code>system_u</code>: user</li>
<li><code>object_r</code>: role</li>
<li><code>s0</code>: type</li>
</ul>

<p>
Ана&shy;ло&shy;гич&shy;но, мож&shy;но по&shy;смот&shy;реть для про&shy;цес&shy;сов:
</p>

<pre class="example">
# ps auxwZ|head -2
LABEL                           USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
system_u:system_r:init_t:s0     root         1  0.0  0.3  19236  1572 ?        Ss   10:54   0:00 /sbin/init
</pre>

<p>
То, что у /sbin/init и у кор&shy;не&shy;вой ди&shy;рек&shy;то&shy;рии оди&shy;на&shy;ко&shy;вый кон&shy;текст ни о
чём не го&shy;во&shy;рит. Пра&shy;ва на до&shy;ступ к кор&shy;ню у init бу&shy;дут толь&shy;ко ес&shy;ли об
этом яв&shy;но ска&shy;за&shy;но в пра&shy;ви&shy;лах по&shy;ли&shy;ти&shy;ки.
</p>

<p>
Точ&shy;но так же мож&shy;но узнать кон&shy;текст те&shy;ку&shy;ще&shy;го шел&shy;ла:
</p>

<pre class="example">
# id -Z
unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
</pre>
</div>
</div>

<<<<<<< HEAD
<div id="outline-container-orgfe2ceb9" class="outline-3">
<h3 id="orgfe2ceb9">Аудит</h3>
<div class="outline-text-3" id="text-orgfe2ceb9">
=======
<div id="outline-container-org43c17c1" class="outline-3">
<h3 id="org43c17c1">Аудит</h3>
<div class="outline-text-3" id="text-org43c17c1">
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
<p>
В ре&shy;жи&shy;мах enforcing и permissive си&shy;сте&shy;ма пи&shy;шет в лог
<code>/var/log/audit/audit.log</code> обо всех со&shy;бы&shy;ти&shy;ях безопа&shy;снос&shy;ти. Этот лог
по&shy;ле&shy;зен как при руч&shy;ном со&shy;зда&shy;нии пра&shy;вил, так и с по&shy;мощью audit2allow.
</p>

<p>
Если auditd не за&shy;пу&shy;щен, со&shy;об&shy;ще&shy;ния уй&shy;дут в <code>/var/log/messages</code>.
</p>
</div>
</div>
</div>

<<<<<<< HEAD
<div id="outline-container-orgcb9ac13" class="outline-2">
<h2 id="orgcb9ac13">Соз&shy;да&shy;ние но&shy;вых пра&shy;вил</h2>
<div class="outline-text-2" id="text-orgcb9ac13">
=======
<div id="outline-container-org968d2bf" class="outline-2">
<h2 id="org968d2bf">Соз&shy;да&shy;ние но&shy;вых пра&shy;вил</h2>
<div class="outline-text-2" id="text-org968d2bf">
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
<p>
Лучше все&shy;го это де&shy;лать че&shy;рез на&shy;пи&shy;са&shy;ние мо&shy;ду&shy;ля. Модуль SELinux мож&shy;но
под&shy;гр&shy;ужать, вы&shy;гру&shy;жать, рас&shy;прост&shy;ра&shy;нять. Удоб&shy;но.
</p>
</div>

<<<<<<< HEAD
<div id="outline-container-orgf00b0a7" class="outline-3">
<h3 id="orgf00b0a7">Общий план</h3>
<div class="outline-text-3" id="text-orgf00b0a7">
=======
<div id="outline-container-org253966a" class="outline-3">
<h3 id="org253966a">Общий план</h3>
<div class="outline-text-3" id="text-org253966a">
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
<ul class="org-ul">
<li>Соз&shy;дать но&shy;вый type для за&shy;пус&shy;ка&shy;емо&shy;го фа&shy;йла</li>
<li>Соз&shy;дать но&shy;вый type, ко&shy;то&shy;рый бу&shy;дет domain ра&shy;бо&shy;та&shy;юще&shy;го при&shy;ло&shy;же&shy;ния</li>
<li>По умо&shy;лча&shy;нию у но&shy;во&shy;го до&shy;ме&shy;на нет ни&shy;ка&shy;ких прав. Поэ&shy;то&shy;му его мож&shy;но
за&shy;пус&shy;тить в permissive mode</li>
<li>С по&shy;мощью audit2allow со&shy;здать ша&shy;блон пра&shy;вил, от&shy;ре&shy;дак&shy;ти&shy;ро&shy;вать их.</li>
<li>Вклю&shy;чить ре&shy;жим enforcing.</li>
</ul>
</div>
</div>

<<<<<<< HEAD
<div id="outline-container-org9d755ac" class="outline-3">
<h3 id="org9d755ac">Соз&shy;да&shy;ние мо&shy;ду&shy;ля</h3>
<div class="outline-text-3" id="text-org9d755ac">
</div>
<div id="outline-container-orge2bca9e" class="outline-4">
<h4 id="orge2bca9e">Подго&shy;то&shy;вка</h4>
<div class="outline-text-4" id="text-orge2bca9e">
=======
<div id="outline-container-org4611b95" class="outline-3">
<h3 id="org4611b95">Соз&shy;да&shy;ние мо&shy;ду&shy;ля</h3>
<div class="outline-text-3" id="text-org4611b95">
</div>
<div id="outline-container-org09bf4e2" class="outline-4">
<h4 id="org09bf4e2">Подго&shy;то&shy;вка</h4>
<div class="outline-text-4" id="text-org09bf4e2">
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
<div class="org-src-container">
<pre class="src src-sh">mkdir <span style="color: #8b2252;">"/root/selinux_my_module"</span>
<span style="color: #483d8b;">cd</span> <span style="color: #8b2252;">"/root/selinux_my_module"</span>
ln -s <span style="color: #8b2252;">"/usr/share/selinux/devel/Makefile"</span>
vim <span style="color: #8b2252;">"my_module.te"</span>
</pre>
</div>
</div>
</div>

<<<<<<< HEAD
<div id="outline-container-org8a56af7" class="outline-4">
<h4 id="org8a56af7">Соз&shy;да&shy;ние ми&shy;ни&shy;маль&shy;но&shy;го мо&shy;ду&shy;ля</h4>
<div class="outline-text-4" id="text-org8a56af7">
=======
<div id="outline-container-org74d5fb6" class="outline-4">
<h4 id="org74d5fb6">Соз&shy;да&shy;ние ми&shy;ни&shy;маль&shy;но&shy;го мо&shy;ду&shy;ля</h4>
<div class="outline-text-4" id="text-org74d5fb6">
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">module</span> <span style="color: #a0522d;">my_module</span> 1.0;

require {
  <span style="color: #228b22;">type</span> <span style="color: #a0522d;">unconfined_t</span>;
  <span style="color: #228b22;">class</span> <span style="color: #a0522d;">process</span> { <span style="color: #228b22;">transition</span> <span style="color: #a0522d;">sigchld</span> };
  <span style="color: #228b22;">class</span> <span style="color: #a0522d;">file</span> { <span style="color: #228b22;">read</span> <span style="color: #a0522d;">x_file_perms</span> };
}

<span style="color: #228b22;">type</span> <span style="color: #a0522d;">mytype_t</span>;
<span style="color: #228b22;">type</span> <span style="color: #a0522d;">mytype_exec_t</span>;

role unconfined_r <span style="color: #228b22;">types</span> <span style="color: #a0522d;">mytype_t</span>;

type_transition <span style="color: #228b22;">unconfined_t</span> <span style="color: #a0522d;">mytype_exec_t</span> : process mytype_t;
</pre>
</div>
</div>
</div>

<<<<<<< HEAD
<div id="outline-container-org670ff31" class="outline-4">
<h4 id="org670ff31">Сбор&shy;ка и за&shy;груз&shy;ка</h4>
<div class="outline-text-4" id="text-org670ff31">
=======
<div id="outline-container-org287a3b2" class="outline-4">
<h4 id="org287a3b2">Сбор&shy;ка и за&shy;груз&shy;ка</h4>
<div class="outline-text-4" id="text-org287a3b2">
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
<div class="org-src-container">
<pre class="src src-sh">make &amp;&amp; make load
</pre>
</div>

<p>
Заг&shy;ру&shy;зить за&shy;но&shy;во по&shy;сле пе&shy;рес&shy;бор&shy;ки:
</p>

<div class="org-src-container">
<pre class="src src-sh">make &amp;&amp; make reload
</pre>
</div>
</div>
</div>

<<<<<<< HEAD
<div id="outline-container-org8b44861" class="outline-4">
<h4 id="org8b44861">Про&shy;вер&shy;ка</h4>
<div class="outline-text-4" id="text-org8b44861">
=======
<div id="outline-container-org87f305f" class="outline-4">
<h4 id="org87f305f">Про&shy;вер&shy;ка</h4>
<div class="outline-text-4" id="text-org87f305f">
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
<div class="org-src-container">
<pre class="src src-sh">cp /bin/date /root/test
chcon -t mytype_exec_t /root/test
setenforce 1
/root/test 
</pre>
</div>

<p>
Сей&shy;час у би&shy;нар&shy;ни&shy;ка нет ни на что прав, по&shy;это&shy;му в по&shy;след&shy;ней строч&shy;ке
дол&shy;жны по&shy;лу&shy;чить <code>/root/test: Permission denied</code>.
</p>
</div>
</div>

<<<<<<< HEAD
<div id="outline-container-org88382da" class="outline-4">
<h4 id="org88382da">Добав&shy;ле&shy;ние пра&shy;вил с по&shy;мощью <a id="org0d63d6c"></a>audit2allow</h4>
<div class="outline-text-4" id="text-org88382da">
<p>
Ути&shy;ли&shy;та пред&shy;на&shy;зна&shy;че&shy;на для ге&shy;не&shy;ра&shy;ции пра&shy;вил на ос&shy;но&shy;ве ло&shy;га <a href="#orgfe2ceb9">ау&shy;ди&shy;та</a>.
=======
<div id="outline-container-org94980a5" class="outline-4">
<h4 id="org94980a5">Добав&shy;ле&shy;ние пра&shy;вил с по&shy;мощью <a id="org2bfd15b"></a>audit2allow</h4>
<div class="outline-text-4" id="text-org94980a5">
<p>
Ути&shy;ли&shy;та пред&shy;на&shy;зна&shy;че&shy;на для ге&shy;не&shy;ра&shy;ции пра&shy;вил на ос&shy;но&shy;ве ло&shy;га <a href="#org43c17c1">ау&shy;ди&shy;та</a>.
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
</p>

<div class="org-src-container">
<pre class="src src-sh">grep mytype /var/log/audit/audit.log | audit2allow -m mytype &gt;my_module.te
</pre>
</div>

<p>
<<<<<<< HEAD
Теперь мож&shy;но по&shy;пра&shy;вить мо&shy;дуль, за&shy;тем за&shy;но&shy;во его <a href="#org670ff31">за&shy;гру&shy;зить</a>.
=======
Теперь мож&shy;но по&shy;пра&shy;вить мо&shy;дуль, за&shy;тем за&shy;но&shy;во его <a href="#org287a3b2">за&shy;гру&shy;зить</a>.
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
</p>
</div>
</div>
</div>

<<<<<<< HEAD
<div id="outline-container-orgfd4710d" class="outline-3">
<h3 id="orgfd4710d">Полез&shy;ные пра&shy;ви&shy;ла</h3>
<div class="outline-text-3" id="text-orgfd4710d">
</div>
<div id="outline-container-org37281e7" class="outline-4">
<h4 id="org37281e7">Воз&shy;мож&shy;ность ме&shy;нять type об&shy;рат&shy;но</h4>
<div class="outline-text-4" id="text-org37281e7">
=======
<div id="outline-container-org21cbda8" class="outline-3">
<h3 id="org21cbda8">Полез&shy;ные пра&shy;ви&shy;ла</h3>
<div class="outline-text-3" id="text-org21cbda8">
</div>
<div id="outline-container-org161ee7b" class="outline-4">
<h4 id="org161ee7b">Воз&shy;мож&shy;ность ме&shy;нять type об&shy;рат&shy;но</h4>
<div class="outline-text-4" id="text-org161ee7b">
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
<p>
По умо&shy;лча&shy;ни
</p>

<pre class="example">
...
require {
...
   class file { ... relabelfrom ... }
}

allow unconfined_t mytype_exec_t:file { ... relabelfrom ... }
</pre>
</div>
</div>

<<<<<<< HEAD
<div id="outline-container-orgb0ec6fb" class="outline-4">
<h4 id="orgb0ec6fb">Базо&shy;вые пра&shy;ви&shy;ла для за&shy;пус&shy;ка фа&shy;йла</h4>
<div class="outline-text-4" id="text-orgb0ec6fb">
=======
<div id="outline-container-orgeb0887e" class="outline-4">
<h4 id="orgeb0887e">Базо&shy;вые пра&shy;ви&shy;ла для за&shy;пус&shy;ка фа&shy;йла</h4>
<div class="outline-text-4" id="text-orgeb0887e">
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
<pre class="example">
# доступ к /
allow mytype_t root_t:dir search;

# разрешить unconfined_t запускать mytype_exec_t
allow unconfined_t mytype_exec_t:file { read getattr open execute };

# разрешить unconfined_t работу с процессом
allow unconfined_t mytype_t:process { siginh rlimitinh transition
noatsecure };

# разрешить unconfined_t менять контекст бинарника и переименовывать его
allow unconfined_t mytype_exec_t:file { rename relabelfrom relabelto };
allow mytype_exec_t fs_t:filesystem associate;
</pre>
</div>
</div>
</div>

<<<<<<< HEAD
<div id="outline-container-org046cfc9" class="outline-3">
<h3 id="org046cfc9">При&shy;мер го&shy;то&shy;во&shy;го мо&shy;ду&shy;ля</h3>
<div class="outline-text-3" id="text-org046cfc9">
=======
<div id="outline-container-orgd90fa28" class="outline-3">
<h3 id="orgd90fa28">При&shy;мер го&shy;то&shy;во&shy;го мо&shy;ду&shy;ля</h3>
<div class="outline-text-3" id="text-orgd90fa28">
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
<p>
Разре&shy;шить би&shy;нар&shy;ни&shy;ку с type mytype_t до&shy;ступ толь&shy;ко к /tmp
</p>

<pre class="example">
module mytype 1.0;

require {
        type unconfined_t;
	type tmp_t;
	type root_t;
	type sshd_t;
	type mytype_t;
	type mytype_exec_t;
	class dir { getattr append read write lock create rename link rmdir open search };
	class file { read entrypoint getattr open execute rename relabelfrom relabelto };
	class process { siginh transition sigchld noatsecure rlimitinh };
	type user_devpts_t;
	class chr_file { open read write getattr append ioctl };
	class fd use;
	class filesystem associate;
}

#============= mytype_t ==============

# access to /
allow mytype_t root_t:dir search;

# access /tmp
allow mytype_t tmp_t:dir { getattr append read write lock create rename link rmdir open search };

# allow general context to run me
allow unconfined_t mytype_exec_t:file { read getattr open execute };

# allow general context to work with my process
allow unconfined_t mytype_t:process { siginh rlimitinh transition noatsecure };

# allow me to write to charcter device
allow mytype_t user_devpts_t:chr_file { read write getattr append ioctl };

# allow general context to switch into my context
type_transition unconfined_t mytype_exec_t : process mytype_t;
allow mytype_t mytype_exec_t:file entrypoint;

# allow me to send SIGCHLD to parent
allow mytype_t unconfined_t:process sigchld;

# allow general context to change to/from my context
allow unconfined_t mytype_exec_t:file { rename relabelfrom relabelto };


## access to pty in SSH session ##
allow mytype_t sshd_t:fd use;
</pre>

<p>
При&shy;мер би&shy;нар&shy;ни&shy;ка для тес&shy;тов:
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;stdio.h&gt;</span>
<span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;dirent.h&gt;</span>
<span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;errno.h&gt;</span>

<span style="color: #228b22;">void</span> <span style="color: #0000ff;">ls</span> (<span style="color: #228b22;">char</span> *<span style="color: #a0522d;">dir</span>) {
  printf(<span style="color: #8b2252;">"\nNow will list %s\n"</span>, dir);

  <span style="color: #228b22;">DIR</span> *<span style="color: #a0522d;">dirp</span> = opendir(dir);
  <span style="color: #a020f0;">if</span> (<span style="color: #008b8b;">NULL</span> == dirp) {
    printf(<span style="color: #8b2252;">"Error opening dir %i\n"</span>, errno);
  }

  <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">dirent</span> *<span style="color: #a0522d;">dp</span>;
  errno = 0;
  <span style="color: #a020f0;">while</span> (dirp) {
    <span style="color: #a020f0;">if</span> ((dp = readdir(dirp)) != <span style="color: #008b8b;">NULL</span>) {
      printf(<span style="color: #8b2252;">"%s\n"</span>, dp-&gt;d_name);
    } <span style="color: #a020f0;">else</span> {
      <span style="color: #a020f0;">if</span> (errno) {
        printf(<span style="color: #8b2252;">"Error readding dir %i\n"</span>, errno);
      }
      <span style="color: #a020f0;">if</span> (closedir(dirp)) {
        printf(<span style="color: #8b2252;">"Error closing dir %i\n"</span>, errno);
      }
      <span style="color: #a020f0;">return</span>;
    }
  }
  <span style="color: #a020f0;">return</span>;
}

<span style="color: #228b22;">int</span> <span style="color: #0000ff;">main</span>() {
  ls (<span style="color: #8b2252;">"/tmp"</span>);
  ls (<span style="color: #8b2252;">"/etc"</span>);

  <span style="color: #a020f0;">return</span> 0;
}
</pre>
</div>

<p>
Соб&shy;ирать ко&shy;неч&shy;но на&shy;до ста&shy;ти&shy;ком:
</p>

<div class="org-src-container">
<pre class="src src-sh">gcc -static a.c
</pre>
</div>

<p>
После это&shy;го не за&shy;быть по&shy;ме&shy;нять context:
</p>

<div class="org-src-container">
<pre class="src src-sh">mv a.out /tmp
chcon -t mytype_t /tmp/a.out
</pre>
</div>
</div>
</div>

<<<<<<< HEAD
<div id="outline-container-org129b613" class="outline-3">
<h3 id="org129b613">Пра&shy;ви&shy;ло для policy "minimum"</h3>
<div class="outline-text-3" id="text-org129b613">
<p>
Если уста&shy;нов&shy;лен minimum, то не&shy;об&shy;хо&shy;ди&shy;мо всем поль&shy;зо&shy;ва&shy;те&shy;лям ро&shy;ли
unconfined_r (а это в по&shy;ли&shy;ти&shy;ке minumum все поль&shy;зо&shy;ва&shy;те&shy;ли) до&shy;ступ к <a href="#orgb17243c">ти&shy;пу</a> mytype_t.
=======
<div id="outline-container-orgcddf4e3" class="outline-3">
<h3 id="orgcddf4e3">Пра&shy;ви&shy;ло для policy "minimum"</h3>
<div class="outline-text-3" id="text-orgcddf4e3">
<p>
Если уста&shy;нов&shy;лен minimum, то не&shy;об&shy;хо&shy;ди&shy;мо всем поль&shy;зо&shy;ва&shy;те&shy;лям ро&shy;ли
unconfined_r (а это в по&shy;ли&shy;ти&shy;ке minumum все поль&shy;зо&shy;ва&shy;те&shy;ли) до&shy;ступ к <a href="#org06fbed7">ти&shy;пу</a> mytype_t.
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
</p>

<pre class="example">
role unconfined_r types mytype_t;
</pre>
</div>
</div>
</div>

<<<<<<< HEAD
<div id="outline-container-orga8d6f72" class="outline-2">
<h2 id="orga8d6f72">Огра&shy;ни&shy;че&shy;ние толь&shy;ко од&shy;но&shy;го би&shy;нар&shy;ни&shy;ка</h2>
<div class="outline-text-2" id="text-orga8d6f72">
=======
<div id="outline-container-orga867c4d" class="outline-2">
<h2 id="orga867c4d">Огра&shy;ни&shy;че&shy;ние толь&shy;ко од&shy;но&shy;го би&shy;нар&shy;ни&shy;ка</h2>
<div class="outline-text-2" id="text-orga867c4d">
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
<ol class="org-ol">
<li>Поста&shy;вить па&shy;кет <code>selinux-policy-minimum</code> (CentOS)</li>
<li>Про&shy;пи&shy;сать этот policy в <code>/etc/selinux/config</code></li>
<li>reboot (мо&shy;жет быть дол&shy;гим ес&shy;ли на&shy;чнет&shy;ся relabeling)</li>
<<<<<<< HEAD
<li>Соз&shy;дать <a href="#org8a56af7">мо&shy;дуль</a>, не за&shy;быть про <a href="#org129b613">Пра&shy;ви&shy;ло для policy "minimum"</a></li>
=======
<li>Соз&shy;дать <a href="#org74d5fb6">мо&shy;дуль</a>, не за&shy;быть про <a href="#orgcddf4e3">Пра&shy;ви&shy;ло для policy "minimum"</a></li>
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
</ol>
</div>
</div>

<<<<<<< HEAD
<div id="outline-container-org2ce128a" class="outline-2">
<h2 id="org2ce128a">Полез&shy;ные ссыл&shy;ки</h2>
<div class="outline-text-2" id="text-org2ce128a">
=======
<div id="outline-container-orgac55cd6" class="outline-2">
<h2 id="orgac55cd6">Полез&shy;ные ссыл&shy;ки</h2>
<div class="outline-text-2" id="text-orgac55cd6">
>>>>>>> 1811a1c09376ef05c12785275fab507739299f31
<ul class="org-ul">
<li><a href="http://fedoraproject.org/wiki/PackagingDrafts/SELinux#Creating_new_types">Creating new types</a></li>
<li><a href="https://selinuxproject.org/page/ObjectClassesPerms">ObjectClassesPerms</a></li>
<li><a href="https://habrahabr.ru/post/332886/">Тем&shy;ные мо&shy;мен&shy;ты SELinux</a></li>
</ul>
</div>
</div>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="Дата создания" class="post-info">2017-10-03</span>
        <span title="Дата последнего изменения" class="post-info">2017-10-07</span>
        <span title="Автор" class="post-info">Evgenii Lepikhin</span>
      </div>
      <span title="Тэги" class="post-info">Тэги: <a href="/tags/selinux/">SELinux</a>, <a href="/tags/безопасность/">безопасность</a>, <a href="/tags/linux/">linux</a>, <a href="/tags/администрирование/">администрирование</a></span>
      <section>
        <h1>Комментарии (выключены)</h1>
      </section>
      <script src="//code.jquery.com/jquery-latest.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script>
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="/media/js/main.js"></script>
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-107728320-1"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-107728320-1');
        </script>
      <div class="footer">
        <p>
          Copyleft 2017 - ∞ <a href="mailto:e &lt;dot&gt; lepikhin &lt;at&gt; corp &lt;dot&gt; mail &lt;dot&gt; ru">Evgenii Lepikhin</a> (<a href="https://github.com/johnlepikhin">GitHub</a>)
        </p>
      </div>
    </div>

  </body>
</html>
